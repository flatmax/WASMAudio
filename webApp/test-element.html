<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../paper-button/paper-button.html">

<dom-module id="test-element">
  <template>
      <paper-button raised on-tap="runAudioWorklet">press and check your console</paper-button>
  </template>

  <script>
    /**
     * `test-element`
     * WASM Test class tester
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class TestElement extends Polymer.Element {
      static get is() { return 'test-element'; }
      static get properties() {
        return {
        };
      }

      /** Load a js file which will load a WASM file.
        \param url the source of the js file, which has to be able to find the wasm file.
        \param onLoadFn The function to run once the script has loaded.
      */
      loadWASM(url, onLoadFn){
        let script = document.createElement('script');
        script.onload = onLoadFn;
        script.src = url;
        document.head.appendChild(script);
      }

      /**
      * Once connected ...
      */
      connectedCallback() {
        super.connectedCallback();
        var me=this;
        this.loadWASM('libwasmaudio.js', function(){me.libwasmaudio=libwasmaudio({onRuntimeInitialized:console.log('libwasmaudio initalised')});}); // load in the wasm file
      }

      /** Run the audio worklet processor
      */
      runAudioWorklet(){
        if (this.context==null)
          this.context = new AudioContext();
        this.context.audioWorklet.addModule('../AudioProcessor.js').then(() => {
          let oscillator = new OscillatorNode(this.context);
          let audioWorkletNode = new AudioWorkletNode(this.context, 'audio-processor');
          oscillator.connect(audioWorkletNode).connect(this.context.destination);
          oscillator.start();
        });
      }
    }

    window.customElements.define(TestElement.is, TestElement);
  </script>
</dom-module>
